# A2A SDK Database Migrations

This directory handles the database schema updates for the A2A SDK. It uses a bundled CLI tool to simplify the migration process for both users and developers of the SDK.

## User Guide (For Integrators)

When you install the `a2a-sdk`, you get a built-in command `a2a-db` to manage your database schema.

### 1. Set your Database URL
Migrations require the `DATABASE_URL` environment variable to be set with an **async-compatible** driver or you can use the `-u` flag to specify the database URL for a single command.

```bash
# SQLite example
export DATABASE_URL="sqlite+aiosqlite://user:pass@host:port/your_database_name"

# PostgreSQL example
export DATABASE_URL="postgresql+asyncpg://user:pass@localhost/your_database_name"

# MySQL example
export DATABASE_URL="mysql+aiomysql://user:pass@localhost/your_database_name"
```

### 2. Apply Migrations
Always run this command after installing or upgrading the SDK to ensure your database matches the required schema.

```bash
# Bring the database to the latest version
a2a-db
```

### 3. Customizing Defaults
Add owner to tasks migration allows you to pass custom values for the new `owner` column. For example, to set a specific default owner for existing tasks:

```bash
a2a-db -o "admin_user"
```

### 4. Rolling Back
If you need to revert a change:

```bash
# Step back one version
a2a-db downgrade -1
```

```bash
# Downgrade to a specific revision ID
a2a-db downgrade <revision_id>
```

```bash
# Revert all migrations
a2a-db downgrade base
```

---

## Developer Guide (For SDK Contributors)

If you are modifying the SDK models and need to generate new migration files, use the following workflow.

### Creating a New Migration
Developers should use the raw `alembic` command locally to generate migrations. Ensure you are in the project root.

```bash
# Detect changes in models.py and generate a script
uv run alembic revision --autogenerate -m "describe your changes"
```

### Internal Layout
- `env.py`: Configures the migration engine and applies the mandatory `DATABASE_URL` check.
- `versions/`: Contains the migration history.
- `script.py.mako`: The template for all new migration files.

## Troubleshooting

### "Duplicate column name"
If your database already has the required tables (e.g., created via `Base.metadata.create_all()` in a legacy script), you may need to "stamp" the database to tell the SDK that it is already up to date:

```bash
# Stamp the database without running SQL commands
# (Requires raw alembic command for developer use)
uv run alembic stamp head
```
