# Database Migrations with Alembic

This directory contains database migration scripts for the A2A SDK, managed by [Alembic](https://alembic.sqlalchemy.org/).

## Configuration

- `alembic.ini`: Global configuration for Alembic, including the database URL.
- `env.py`: Python script that runs when the Alembic environment is invoked. It configures the SQLAlchemy engine and connects it to the migration context.
- `versions/`: Directory containing individual migration scripts.

## Common Commands

All commands should be run from the project root using `uv run`.

### Viewing Status
```bash
# View current migration version of the database
uv run alembic current

# View migration history
uv run alembic history --verbose
```

### Running Migrations
```bash
# Upgrade to the latest version
uv run alembic upgrade head

# Downgrade by one version
uv run alembic downgrade base
```

### Creating Migrations
```bash
# Create a new migration manually
uv run alembic revision -m "description of changes"

# Create a new migration automatically (detects changes in models.py)
uv run alembic revision --autogenerate -m "description of changes"
```

## Troubleshooting

### "duplicate column name" error
If you see an error like `sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) duplicate column name: owner`, it usually means the column was already created (perhaps by `Base.metadata.create_all()` in tests or development) but Alembic doesn't know about it yet.

To fix this, "stamp" the database to tell Alembic it is already at the latest version:
```bash
uv run alembic stamp head
```

## How to add a new migration
1. Modify the models in `src/a2a/server/models.py`.
2. Run `uv run alembic revision --autogenerate -m "Add new field to Task"`.
3. Review the generated script in `alembic/versions/`.
4. Apply the migration with `uv run alembic upgrade head`.
